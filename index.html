<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HonKassif | Vault</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050507;
            --bg-gradient: radial-gradient(circle at top right, #1a1f35 0%, #050507 100%);
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --brand-glow: #00f2ff;
            --accent-mint: #00ff9d;
            --accent-rose: #ff4757;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Assistant', sans-serif;
            background: var(--bg-dark);
            background-image: var(--bg-gradient);
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
        }

        /* HEADER - FORCED LTR */
        .header-bar {
            position: fixed; top: 0; left: 0; right: 0;
            padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(5, 5, 7, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 1000;
            direction: ltr; /* Force English layout for header */
        }
        
        /* BRANDING FIXES */
        .brand-container {
            direction: ltr !important; /* STRICT LTR FOR LOGO */
            display: inline-block;
        }
        .brand-sm { 
            font-size: 24px; 
            font-weight: 300; /* Lighter weight looks less like caps */
            letter-spacing: 1px; 
            text-transform: none !important; /* FORCE NO CAPS */
            font-family: 'Assistant', sans-serif;
        }
        .brand-sm strong { font-weight: 700; }
        .brand-sm span { color: var(--brand-glow); }

        .wrapper { max-width: 1600px; margin: auto; padding: 40px; padding-top: 120px; display: none; }
        
        /* UTILS */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }
        .btn-glow {
            background: linear-gradient(135deg, rgba(0,242,255,0.1), rgba(0,242,255,0));
            border: 1px solid var(--brand-glow);
            color: var(--brand-glow);
            padding: 8px 24px; border-radius: 50px;
            cursor: pointer; font-weight: 700;
            transition: 0.3s;
        }
        .btn-glow:hover { box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        .btn-glass {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 20px; border-radius: 50px;
            cursor: pointer; font-weight: 600;
        }

        /* STATS */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 25px; display: flex; flex-direction: column; justify-content: space-between; min-height: 100px; }
        .label { color: var(--text-muted); font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
        .val { font-size: 28px; font-weight: 300; letter-spacing: -1px; margin-top: 5px; }

        /* TABLE */
        .table-wrap { overflow: visible; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        
        th { 
            text-align: right; padding: 15px 20px; 
            color: var(--text-muted); font-size: 12px; font-weight: 600; 
            border-bottom: 1px solid var(--glass-border);
            position: relative; user-select: none;
        }
        th.sortable { cursor: pointer; transition: color 0.2s; }
        th.sortable:hover { color: var(--brand-glow); }
        
        /* FILTERS */
        .th-content { display: flex; align-items: center; gap: 8px; }
        .filter-icon { 
            font-size: 10px; cursor: pointer; padding: 4px; 
            opacity: 0.5; transition: 0.2s; 
        }
        .filter-icon:hover, .filter-icon.active { opacity: 1; color: var(--brand-glow); }

        .filter-dropdown {
            position: absolute; top: 100%; right: 0;
            background: #0f111a; border: 1px solid var(--glass-border);
            border-radius: 8px; padding: 5px 0;
            min-width: 150px; z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
        }
        .filter-dropdown.show { display: block; }
        .filter-item {
            padding: 8px 15px; font-size: 13px; color: var(--text-main);
            cursor: pointer; transition: 0.2s;
            text-align: right;
        }
        .filter-item:hover { background: rgba(255,255,255,0.05); color: var(--brand-glow); }

        td { padding: 8px 20px; border-bottom: 1px solid var(--glass-border); }
        input { 
            background: transparent; border: none; font-size: 14px; 
            font-family: inherit; width: 100%; color: var(--text-main); 
            text-align: right; padding: 5px; 
        }
        input:focus { background: rgba(255,255,255,0.05); outline: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        tr.hidden { display: none; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; background: var(--bg-dark); background-image: var(--bg-gradient); }
        .lock-box { width: 400px; text-align: center; padding: 60px 40px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(30px); border-radius: 24px; }
        .pass-input { width: 100%; padding: 18px; margin: 30px 0; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; font-size: 18px; text-align: center; border-radius: 12px; outline: none; }
        .pass-input:focus { border-color: var(--brand-glow); }
        
        #action-bar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); width: 500px; background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-radius: 50px; transition: 0.4s; z-index: 9999; }
        #action-bar.visible { bottom: 40px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="lock-box">
            <div class="brand-container">
                <div class="brand-sm" style="font-size: 40px; margin-bottom: 20px;">Hon<strong>Kassif</strong><span>.</span></div>
            </div>
            
            <p id="auth-status" style="font-size:12px; color:var(--text-muted); margin-top: 10px;">INITIALIZING SECURE CONNECTION...</p>
            
            <div id="password-section" style="display:none;">
                <input type="password" id="system-pass" class="pass-input" placeholder="ENTER MASTER KEY" onkeypress="if(event.keyCode==13) handlePassClick()">
                <button onclick="handlePassClick()" class="btn-glow" style="width:100%">DECRYPT VAULT</button>
                <p id="error-msg" style="color:var(--accent-rose); font-size:12px; margin-top:20px; display:none;">ACCESS DENIED</p>
            </div>
            <button id="manual-auth" onclick="requestToken()" class="btn-glass" style="display:none; margin-top:20px;">CONNECT GOOGLE DRIVE</button>
        </div>
    </div>

    <div class="header-bar" id="app-header" style="display:none;">
        <div class="brand-container">
            <div class="brand-sm">Hon<strong>Kassif</strong><span>.</span></div>
        </div>
        <button onclick="location.reload()" class="btn-glass" style="font-size:12px;">LOCK SESSION</button>
    </div>

    <div class="wrapper" id="main-app">
        <div class="stats">
            <div class="stat-card glass-panel"><span class="label">Total Net Worth</span><span class="val" id="total-val">0 ₪</span></div>
            <div class="stat-card glass-panel"><span class="label">Net Performance</span><span class="val" id="total-pl">0 ₪</span></div>
            <div class="stat-card glass-panel"><span class="label">Total Invested</span><span class="val" id="total-cost">0 ₪</span></div>
            <div class="stat-card glass-panel"><span class="label">ROI</span><span class="val" id="total-pct">0.00%</span></div>
        </div>

        <div style="margin-bottom:20px; display:flex; gap:15px;">
            <button onclick="addRow()" class="btn-glow">+ ADD ASSET</button>
            <button onclick="document.getElementById('csv-input').click()" class="btn-glass">IMPORT CSV</button>
            <input type="file" id="csv-input" style="display:none;" onchange="handleImport(this)">
        </div>

        <div class="table-wrap glass-panel">
            <table id="asset-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortIdx=0; sortTable(0)">
                            <div class="th-content">
                                CATEGORY <span class="filter-icon" onclick="event.stopPropagation(); toggleFilter(0)">▼</span>
                                <div class="filter-dropdown" id="filter-0"></div>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortIdx=1; sortTable(1)">
                            <div class="th-content">
                                MANAGER <span class="filter-icon" onclick="event.stopPropagation(); toggleFilter(1)">▼</span>
                                <div class="filter-dropdown" id="filter-1"></div>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortIdx=2; sortTable(2)">
                            <div class="th-content">
                                PRODUCT <span class="filter-icon" onclick="event.stopPropagation(); toggleFilter(2)">▼</span>
                                <div class="filter-dropdown" id="filter-2"></div>
                            </div>
                        </th>
                        <th class="sortable" style="width:12%" onclick="sortTable(3)">ORIGINAL (₪)</th>
                        <th class="sortable" style="width:12%" onclick="sortTable(4)">CURRENT (₪)</th>
                        <th class="sortable" style="width:10%" onclick="sortTable(5)">DATE</th>
                        <th style="width:8%">FEES</th>
                        <th style="width:15%">NOTES</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="action-bar">
        <div style="font-weight: 500; font-size:14px;">Unsaved changes detected.</div>
        <div style="display: flex; gap: 10px;">
            <button style="background:transparent; color:var(--text-muted); border:none; cursor:pointer;" onclick="location.reload()">DISCARD</button>
            <button style="background:var(--brand-glow); color:black; border:none; padding:8px 20px; border-radius:25px; font-weight:700; cursor:pointer;" onclick="confirmAndSync()">SYNC</button>
        </div>
    </div>

    <script>
        const CLIENT_ID = '297089944806-tj0q6nbclm1n9054a8g6qeluuuvkfh3h.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyC9_bl_BGr2_mukKq2ygfTSLTUd_8zrVec';
        let accessToken, tokenClient, savedVault = null;
        let sortDir = 1;

        window.onload = () => {
            gapi.load('client', () => gapi.client.init({apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']}));
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (res) => { accessToken = res.access_token; checkVault(); }
            });
            // FASTER AUTO-LOGIN ATTEMPT (500ms instead of 1000ms)
            setTimeout(() => { tokenClient.requestAccessToken({prompt: 'none', login_hint: 'kassifo@gmail.com'}); }, 500);
            
            // WAIT LONGER BEFORE SHOWING "SESSION EXPIRED" (4000ms)
            setTimeout(() => { if(!accessToken) { 
                document.getElementById('auth-status').innerText = 'SESSION EXPIRED';
                document.getElementById('manual-auth').style.display = 'block';
            }}, 4000);

            document.addEventListener('click', function(event) {
                if (!event.target.closest('.th-content')) {
                    document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('show'));
                }
            });
        };

        function requestToken() { tokenClient.requestAccessToken({prompt: '', login_hint: 'kassifo@gmail.com'}); }

        async function hashPassword(string) {
            const utf8 = new TextEncoder().encode(string);
            const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkVault() {
            document.getElementById('auth-status').innerText = 'VAULT FOUND. DECRYPTING...';
            const res = await fetch('https://www.googleapis.com/drive/v3/files?q=name="OrenPMS_Vault.json"', { headers: { 'Authorization': 'Bearer ' + accessToken } });
            const data = await res.json();
            if (data.files && data.files.length > 0) {
                const fileRes = await fetch(`https://www.googleapis.com/drive/v3/files/${data.files[0].id}?alt=media`, { headers: { 'Authorization': 'Bearer ' + accessToken } });
                savedVault = await fileRes.json();
                showPasswordInput();
            } else {
                document.getElementById('auth-status').innerText = 'NEW SYSTEM DETECTED';
                showPasswordInput(true);
            }
        }

        function showPasswordInput(isSetup = false) {
            document.getElementById('auth-status').style.display = 'none';
            document.getElementById('manual-auth').style.display = 'none';
            document.getElementById('password-section').style.display = 'block';
            if(isSetup) document.getElementById('system-pass').placeholder = 'CREATE MASTER KEY';
            setTimeout(() => document.getElementById('system-pass').focus(), 100);
        }

        async function handlePassClick() {
            const inputPass = document.getElementById('system-pass').value;
            const hashedInput = await hashPassword(inputPass);
            if (!savedVault) {
                savedVault = { passwordHash: hashedInput, rows: [] };
                await confirmAndSync();
                unlock();
            } else if (hashedInput === savedVault.passwordHash) {
                unlock();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function unlock() {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-header').style.display='flex';
            document.getElementById('main-app').style.display='block';
            if (savedVault.rows) {
                document.getElementById('table-body').innerHTML = '';
                savedVault.rows.forEach(r => addRow(r));
            } else { addRow(); }
            updateFilters();
        }

        function calculateTotals() {
            let totalMarket = 0, totalCost = 0;
            document.querySelectorAll('#table-body tr:not(.hidden)').forEach(row => {
                const inputs = row.querySelectorAll('input');
                totalCost += parseFloat(inputs[3].value.replace(/,/g,'')) || 0;
                totalMarket += parseFloat(inputs[4].value.replace(/,/g,'')) || 0;
            });
            document.getElementById('total-val').innerText = totalMarket.toLocaleString() + ' ₪';
            document.getElementById('total-cost').innerText = totalCost.toLocaleString() + ' ₪';
            const net = totalMarket - totalCost;
            document.getElementById('total-pl').innerText = (net >= 0 ? '+' : '') + net.toLocaleString() + ' ₪';
            document.getElementById('total-pl').style.color = net >= 0 ? 'var(--accent-mint)' : 'var(--accent-rose)';
            document.getElementById('total-pct').innerText = (totalCost !== 0 ? (net/totalCost*100).toFixed(2) : '0.00') + '%';
            document.getElementById('total-pct').style.color = net >= 0 ? 'var(--accent-mint)' : 'var(--accent-rose)';
        }

        function addRow(item = {cols:['','','','','','','',''], history:[]}) {
            const tr = document.createElement('tr');
            tr.dataset.history = JSON.stringify(item.history || []);
            tr.dataset.originalValues = JSON.stringify(item.cols);
            tr.innerHTML = item.cols.map((val, i) => `<td><input type="text" value="${val}" oninput="handleEdit(this, ${i})"></td>`).join('');
            document.getElementById('table-body').appendChild(tr);
            calculateTotals();
        }

        function handleEdit(input, colIndex) {
            const tr = input.closest('tr');
            if(colIndex === 4) {
                const d = new Date();
                tr.querySelectorAll('input')[5].value = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear().toString().slice(-2)}`;
            }
            tr.classList.add('dirty');
            document.getElementById('action-bar').classList.add('visible');
            calculateTotals();
            if(colIndex < 3) updateFilters();
        }

        async function confirmAndSync() {
            const rows = Array.from(document.querySelectorAll('#table-body tr')).map(tr => {
                const currentCols = Array.from(tr.querySelectorAll('input')).map(i => i.value);
                const originalCols = JSON.parse(tr.dataset.originalValues);
                let history = JSON.parse(tr.dataset.history);
                if (currentCols[4] !== originalCols[4] && originalCols[4] !== "") {
                    history.push({ val: originalCols[4], date: originalCols[5] });
                }
                return { cols: currentCols, history: history };
            });
            const vaultData = { passwordHash: savedVault.passwordHash, rows: rows };
            const metadata = { name: 'OrenPMS_Vault.json', mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', new Blob([JSON.stringify(vaultData)], {type: 'application/json'}));
            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { 'Authorization': 'Bearer ' + accessToken }, body: form });
            location.reload();
        }

        function sortTable(colIndex) {
            const tbody = document.getElementById('table-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            sortDir *= -1; 
            rows.sort((a, b) => {
                const valA = a.querySelectorAll('input')[colIndex].value.toLowerCase().replace(/,/g,'');
                const valB = b.querySelectorAll('input')[colIndex].value.toLowerCase().replace(/,/g,'');
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB) && valA !== '' && valB !== '') return (numA - numB) * sortDir;
                return valA.localeCompare(valB) * sortDir;
            });
            rows.forEach(row => tbody.appendChild(row));
        }

        function toggleFilter(colIndex) {
            const drop = document.getElementById('filter-' + colIndex);
            document.querySelectorAll('.filter-dropdown').forEach(d => { if(d !== drop) d.classList.remove('show'); });
            drop.classList.toggle('show');
        }

        function updateFilters() {
            [0,1,2].forEach(idx => {
                const values = new Set();
                document.querySelectorAll('#table-body tr').forEach(row => { values.add(row.querySelectorAll('input')[idx].value); });
                const drop = document.getElementById('filter-' + idx);
                drop.innerHTML = '<div class="filter-item" onclick="applyFilter('+idx+', \'ALL\')">SHOW ALL</div>';
                Array.from(values).sort().forEach(val => {
                    if(val) drop.innerHTML += `<div class="filter-item" onclick="applyFilter(${idx}, '${val.replace(/'/g, "\\'")}')">${val}</div>`;
                });
            });
        }

        function applyFilter(colIndex, filterVal) {
            document.querySelectorAll('#table-body tr').forEach(row => {
                const cellVal = row.querySelectorAll('input')[colIndex].value;
                if (filterVal === 'ALL' || cellVal === filterVal) row.classList.remove('hidden');
                else row.classList.add('hidden');
            });
            calculateTotals();
        }

        function handleImport(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                lines.forEach(line => {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 2) addRow({cols: parts.concat(Array(8-parts.length).fill('')), history: []});
                });
                document.getElementById('action-bar').classList.add('visible');
                updateFilters();
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
